// This Pine Script‚Ñ¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© ARRA7 Trading - High-Probability Zone Finder
// Version 1.0

//@version=5
indicator("ARRA7 HP Zone Finder", overlay=true, max_boxes_count=100, max_labels_count=100)

// ============================================
// SETTINGS
// ============================================
// Williams %R Settings
wrLength = input.int(14, "Williams %R Length", minval=1, group="Williams %R")
wrOB = input.int(-20, "Overbought Level", maxval=0, group="Williams %R")
wrOS = input.int(-80, "Oversold Level", maxval=0, group="Williams %R")
showWRZones = input.bool(true, "Show W%R Extreme Zones", group="Williams %R")

// KAMA Settings
kamaLength = input.int(21, "KAMA Length", minval=1, group="KAMA Trend")
kamaFast = input.float(2, "KAMA Fast", group="KAMA Trend")
kamaSlow = input.float(30, "KAMA Slow", group="KAMA Trend")
showKAMA = input.bool(true, "Show KAMA Line", group="KAMA Trend")

// S/R Settings
showSR = input.bool(true, "Show S/R Zones", group="Support/Resistance")
srLength = input.int(20, "S/R Lookback", group="Support/Resistance")
srStrength = input.int(3, "S/R Strength (touches)", minval=1, maxval=10, group="Support/Resistance")
srColor = input.color(color.new(color.purple, 70), "S/R Zone Color", group="Support/Resistance")

// Signal Settings
showSignals = input.bool(true, "Show Entry Signals", group="Signals")
confluenceRequired = input.int(2, "Min Confluence Factors", minval=1, maxval=3, group="Signals")

// Alerts
showAlerts = input.bool(true, "Enable Alerts", group="Alerts")

// ============================================
// WILLIAMS %R CALCULATION
// ============================================
wr = ta.wpr(wrLength)

// Extreme zones
isWROversold = wr <= wrOS
isWROverbought = wr >= wrOB

// Exiting extreme zones (potential reversal)
wrBullSignal = ta.crossover(wr, wrOS)
wrBearSignal = ta.crossunder(wr, wrOB)

// ============================================
// KAMA (Kaufman Adaptive Moving Average)
// ============================================
// Efficiency Ratio
change_kama = math.abs(close - close[kamaLength])
volatility = math.sum(math.abs(close - close[1]), kamaLength)
er = volatility != 0 ? change_kama / volatility : 0

// Smoothing Constants
fastSC = 2 / (kamaFast + 1)
slowSC = 2 / (kamaSlow + 1)
sc = math.pow(er * (fastSC - slowSC) + slowSC, 2)

// KAMA Calculation
var float kama = na
kama := na(kama[1]) ? close : kama[1] + sc * (close - kama[1])

// KAMA Trend
kamaBullish = close > kama
kamaBearish = close < kama

// Plot KAMA
kamaColor = kamaBullish ? color.lime : color.red
plot(showKAMA ? kama : na, "KAMA", color=kamaColor, linewidth=2)

// ============================================
// FRACTAL S/R DETECTION
// ============================================
fractalUp = ta.pivothigh(high, srLength, srLength)
fractalDown = ta.pivotlow(low, srLength, srLength)

// Store S/R levels
var float[] resistanceLevels = array.new_float(0)
var float[] supportLevels = array.new_float(0)

// Add new fractals
if not na(fractalUp)
    array.push(resistanceLevels, fractalUp)
    if array.size(resistanceLevels) > 10
        array.shift(resistanceLevels)

if not na(fractalDown)
    array.push(supportLevels, fractalDown)
    if array.size(supportLevels) > 10
        array.shift(supportLevels)

// Find nearest S/R
findNearestSR(levels, price, tolerance) =>
    nearestLevel = 0.0
    nearestDist = 999999.0
    for i = 0 to array.size(levels) - 1
        level = array.get(levels, i)
        dist = math.abs(price - level)
        if dist < nearestDist and dist < tolerance
            nearestDist := dist
            nearestLevel := level
    nearestLevel

// Check if price is near S/R
tolerance = ta.atr(14) * 1.5
nearSupport = findNearestSR(supportLevels, close, tolerance) > 0
nearResistance = findNearestSR(resistanceLevels, close, tolerance) > 0

// Draw S/R zones
if showSR
    if not na(fractalUp)
        srTop = fractalUp + ta.atr(14) * 0.3
        srBottom = fractalUp - ta.atr(14) * 0.3
        box.new(bar_index - srLength, srTop, bar_index + 20, srBottom, border_color=color.red, bgcolor=color.new(color.red, 85), border_width=1)
        label.new(bar_index - srLength, fractalUp, "R", style=label.style_label_down, color=color.new(color.red, 50), textcolor=color.white, size=size.tiny)
    
    if not na(fractalDown)
        srTop = fractalDown + ta.atr(14) * 0.3
        srBottom = fractalDown - ta.atr(14) * 0.3
        box.new(bar_index - srLength, srTop, bar_index + 20, srBottom, border_color=color.green, bgcolor=color.new(color.green, 85), border_width=1)
        label.new(bar_index - srLength, fractalDown, "S", style=label.style_label_up, color=color.new(color.green, 50), textcolor=color.white, size=size.tiny)

// ============================================
// CONFLUENCE CALCULATION
// ============================================
// Count bullish confluence factors
bullConfluence = 0
bullConfluence := bullConfluence + (isWROversold or wrBullSignal ? 1 : 0)
bullConfluence := bullConfluence + (kamaBullish ? 1 : 0)
bullConfluence := bullConfluence + (nearSupport ? 1 : 0)

// Count bearish confluence factors
bearConfluence = 0
bearConfluence := bearConfluence + (isWROverbought or wrBearSignal ? 1 : 0)
bearConfluence := bearConfluence + (kamaBearish ? 1 : 0)
bearConfluence := bearConfluence + (nearResistance ? 1 : 0)

// ============================================
// HIGH PROBABILITY SIGNALS
// ============================================
hpBuySignal = bullConfluence >= confluenceRequired and wrBullSignal
hpSellSignal = bearConfluence >= confluenceRequired and wrBearSignal

// Draw signals
if showSignals and hpBuySignal
    label.new(bar_index, low, "üéØ HP BUY\n" + str.tostring(bullConfluence) + "/3", style=label.style_label_up, color=color.new(color.lime, 20), textcolor=color.white, size=size.small)

if showSignals and hpSellSignal
    label.new(bar_index, high, "üéØ HP SELL\n" + str.tostring(bearConfluence) + "/3", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small)

// Plot signals for strategy
plotshape(hpBuySignal, "HP Buy", shape.triangleup, location.belowbar, color.lime, size=size.normal)
plotshape(hpSellSignal, "HP Sell", shape.triangledown, location.abovebar, color.red, size=size.normal)

// ============================================
// W%R BACKGROUND ZONES
// ============================================
wrZoneColor = isWROversold ? color.new(color.green, 90) : isWROverbought ? color.new(color.red, 90) : na
bgcolor(showWRZones ? wrZoneColor : na)

// ============================================
// ALERTS
// ============================================
if showAlerts
    if hpBuySignal
        alert("üéØ ARRA7 HP Zone Finder: BUY Signal!\n" + syminfo.ticker + " @ " + str.tostring(close) + "\nConfluence: " + str.tostring(bullConfluence) + "/3\n‚Ä¢ W%R Oversold ‚úì\n‚Ä¢ KAMA Bullish " + (kamaBullish ? "‚úì" : "‚úó") + "\n‚Ä¢ Near Support " + (nearSupport ? "‚úì" : "‚úó"), alert.freq_once_per_bar)
    
    if hpSellSignal
        alert("üéØ ARRA7 HP Zone Finder: SELL Signal!\n" + syminfo.ticker + " @ " + str.tostring(close) + "\nConfluence: " + str.tostring(bearConfluence) + "/3\n‚Ä¢ W%R Overbought ‚úì\n‚Ä¢ KAMA Bearish " + (kamaBearish ? "‚úì" : "‚úó") + "\n‚Ä¢ Near Resistance " + (nearResistance ? "‚úì" : "‚úó"), alert.freq_once_per_bar)

// ============================================
// INFO TABLE
// ============================================
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "üíé ARRA7 HP Zone Finder", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "v1.0", text_color=color.gray, text_size=size.tiny)
    
    // Williams %R
    wrColor = isWROversold ? color.lime : isWROverbought ? color.red : color.white
    wrStatus = isWROversold ? "OVERSOLD ‚úì" : isWROverbought ? "OVERBOUGHT ‚úì" : "NEUTRAL"
    table.cell(infoTable, 0, 1, "Williams %R", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 1, str.tostring(wr, "#.0") + " " + wrStatus, text_color=wrColor, text_size=size.small)
    
    // KAMA Trend
    kamaStatus = kamaBullish ? "üìà BULLISH ‚úì" : "üìâ BEARISH ‚úì"
    table.cell(infoTable, 0, 2, "KAMA Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 2, kamaStatus, text_color=kamaColor, text_size=size.small)
    
    // S/R
    srStatus = nearSupport ? "Near Support ‚úì" : nearResistance ? "Near Resistance ‚úì" : "No S/R nearby"
    srClr = nearSupport ? color.lime : nearResistance ? color.red : color.gray
    table.cell(infoTable, 0, 3, "S/R Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 3, srStatus, text_color=srClr, text_size=size.small)
    
    // Bull Confluence
    bullClr = bullConfluence >= confluenceRequired ? color.lime : color.gray
    table.cell(infoTable, 0, 4, "Bull Factors", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 4, str.tostring(bullConfluence) + "/3", text_color=bullClr, text_size=size.small)
    
    // Bear Confluence
    bearClr = bearConfluence >= confluenceRequired ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Bear Factors", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 5, str.tostring(bearConfluence) + "/3", text_color=bearClr, text_size=size.small)
    
    // Setup
    setupText = bullConfluence >= confluenceRequired ? "üü¢ LOOK FOR BUY" : bearConfluence >= confluenceRequired ? "üî¥ LOOK FOR SELL" : "‚è≥ WAIT FOR SETUP"
    table.cell(infoTable, 0, 6, "Setup", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 6, setupText, text_color=color.yellow, text_size=size.small)
    
    table.cell(infoTable, 0, 7, "¬© ARRA7 Trading", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 7, "arra7-app.vercel.app", text_color=color.aqua, text_size=size.tiny)
